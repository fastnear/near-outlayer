# OffchainVM Worker Configuration
# Copy this file to .env and fill in your values

# ============================================================================
# REQUIRED CONFIGURATION
# ============================================================================

# Coordinator API Configuration
# URL of the coordinator API service
API_BASE_URL=http://localhost:8080

# Bearer token for authenticating with coordinator API
# Must match the token configured in coordinator
API_AUTH_TOKEN=your_secret_token_here

# NEAR Network Configuration
# RPC endpoint for NEAR blockchain
# Testnet: https://rpc.testnet.near.org
# Mainnet: https://rpc.mainnet.near.org
# For RPC providers with API keys, include the key in the URL:
#   Example (Pagoda): https://near-testnet.api.pagoda.co/rpc/v1/YOUR_API_KEY
#   Example (Infura): https://near-testnet.infura.io/v3/YOUR_API_KEY
NEAR_RPC_URL=https://rpc.testnet.near.org

# Neardata API URL for event monitoring
# Testnet: https://testnet.neardata.xyz/v0/block
# Mainnet: https://mainnet.neardata.xyz/v0/block
# For Neardata with API keys, include the key in the URL as query parameter:
#   Example: https://testnet.neardata.xyz/v0/block?api_key=YOUR_API_KEY
# Default: https://testnet.neardata.xyz/v0/block
# NEARDATA_API_URL=https://testnet.neardata.xyz/v0/block/{block_id}?apiKey=key

# Starting block height for event monitoring
# Use 0 to auto-detect latest block (fetches from FastNEAR API)
# Or specify a block number to start from specific height
# Default: 0 (auto-detect)
# START_BLOCK_HEIGHT=0

# FastNEAR API URL for fetching latest block height
# Auto-detected based on NEARDATA_API_URL (testnet/mainnet)
# Testnet: https://test.api.fastnear.com/status
# Mainnet: https://api.fastnear.com/status
# FASTNEAR_API_URL=https://test.api.fastnear.com/status

# OffchainVM contract account ID on NEAR
# This is the contract that emits execution_requested events
OFFCHAINVM_CONTRACT_ID=outlayer.testnet

# Worker operator account ID
# This account must have operator role on the OffchainVM contract
# and sufficient NEAR balance for gas fees
OPERATOR_ACCOUNT_ID=worker.outlayer.testnet

# ============================================================================
# WORKER REGISTRATION MODE
# ============================================================================

# Use TEE registration flow (recommended for production with Phala Cloud)
# If true: Worker generates ephemeral keypair in TEE and registers via REGISTER_CONTRACT_ID
# If false: Worker uses OPERATOR_PRIVATE_KEY (legacy mode for testnet)
# Default: true
USE_TEE_REGISTRATION=true

# ============================================================================
# OPTION 1: TEE Registration Mode (USE_TEE_REGISTRATION=true)
# ============================================================================
# Worker generates ephemeral keypair in TEE and registers it as function call access key.
# Requires REGISTER_CONTRACT_ID and INIT_ACCOUNT_* credentials.
# OPERATOR_PRIVATE_KEY is NOT needed and will be IGNORED.

# Register contract account ID (same as worker account)
# Example: worker.outlayer.testnet
# REGISTER_CONTRACT_ID=worker.outlayer.testnet

# Init account credentials (shared across workers, pays for registration gas)
# INIT_ACCOUNT_ID=init-worker.outlayer.testnet
# INIT_ACCOUNT_PRIVATE_KEY=ed25519:YOUR_INIT_ACCOUNT_KEY_HERE

# DEPRECATED: REGISTER_COLLATERAL_JSON is no longer needed
# Worker now auto-fetches collateral from Phala Cloud API when registration fails
# with "Quote collateral required" error. The collateral JSON will be printed in logs
# for you to cache in the register contract using update_collateral method.

# ============================================================================
# OPTION 2: Legacy Mode (USE_TEE_REGISTRATION=false)
# ============================================================================
# Worker uses manually provided private key (for testnet without TEE).
# Requires OPERATOR_PRIVATE_KEY, no registration needed.

# Operator account private key (ed25519 format)
# Generate with: near-cli keys <account_id>
# Format: ed25519:base58_encoded_private_key
#
# ⚠️  CRITICAL SECURITY NOTE:
# This key is ONLY for calling resolve_execution() on OutLayer contract!
# This key is NEVER passed to WASM and NEVER used for signing user transactions.
# User transactions are signed with keys provided by WASM via secrets mechanism.
#
# OPERATOR_PRIVATE_KEY=ed25519:YOUR_PRIVATE_KEY_HERE

# ============================================================================
# OPTIONAL CONFIGURATION (with defaults)
# ============================================================================

# Worker Settings
# Unique identifier for this worker instance
# Default: random UUID
# WORKER_ID=worker-1

# Enable NEAR blockchain event monitoring
# If true, worker monitors blockchain for execution_requested events
# If false, worker only polls coordinator API for tasks
# Default: false
# ENABLE_EVENT_MONITOR=false

# Long-poll timeout in seconds (1-300)
# How long to wait for new tasks before timing out
# Default: 60
# POLL_TIMEOUT_SECONDS=60

# Scan interval in seconds between block checks
# How long to wait between checking for new blocks
# Default: 1
# SCAN_INTERVAL_SECONDS=1

# Docker Compilation Settings
# Docker image to use for compiling GitHub repositories
# Supports wasm32-wasi, wasm32-wasip1, wasm32-wasip2 targets
# Recommended: zavodil/wasmedge-compiler:latest (includes Rust 1.85 + WASI SDK 25 + wasm32-wasip2)
# Default: rust:1.75 (basic Rust with wasm32-wasi support only)
# DOCKER_IMAGE=zavodil/wasmedge-compiler:latest

# Maximum time allowed for compilation in seconds (1-3600)
# Default: 300 (5 minutes)
# COMPILE_TIMEOUT_SECONDS=300

# Maximum memory for compilation in MB (minimum 512)
# Default: 2048 (2 GB)
# COMPILE_MEMORY_LIMIT_MB=2048

# Maximum CPU cores for compilation
# Default: 2.0
# COMPILE_CPU_LIMIT=2.0

# WASM Execution Default Limits
# These are used when the contract doesn't specify limits

# Maximum number of WASM instructions
# Default: 10000000000 (10 billion)
# DEFAULT_MAX_INSTRUCTIONS=10000000000

# Maximum memory usage in MB
# Default: 128
# DEFAULT_MAX_MEMORY_MB=128

# Maximum execution time in seconds
# Default: 60
# DEFAULT_MAX_EXECUTION_SECONDS=60

# ============================================================================
# FASTFS CONFIGURATION (Optional - for storing compiled WASM)
# ============================================================================

# FastFS receiver contract account ID
# If set, worker can upload compiled WASM to FastFS when store_on_fastfs=true
# Testnet: fastfs.testnet
# Mainnet: fastfs.near
# FASTFS_RECEIVER=fastfs.testnet

# FastFS sender account (optional - separate account for paying storage)
# If not set, uses OPERATOR account
# Recommended: use dedicated account with sufficient NEAR balance for storage costs
# FASTFS_SENDER_ACCOUNT_ID=fastfs-sender.testnet
# FASTFS_SENDER_PRIVATE_KEY=ed25519:YOUR_FASTFS_SENDER_KEY_HERE

# ============================================================================
# NEAR RPC PROXY (for WASM host functions)
# ============================================================================

# Enable NEAR RPC proxy host functions for WASM code
# When enabled, WASI P2 components can call NEAR RPC through host functions
# without exposing API keys to the WASM code
# Default: true
# NEAR_RPC_PROXY_ENABLED=true

# RPC URL for NEAR proxy requests (separate from worker's NEAR_RPC_URL)
# Use this to provide a paid RPC endpoint with API key for WASM code
# If not set, falls back to NEAR_RPC_URL
# NEAR_RPC_PROXY_URL=https://rpc.testnet.fastnear.com?apiKey=YOUR_API_KEY

# Maximum NEAR RPC calls per single WASM execution (rate limiting)
# Prevents WASM code from making excessive RPC calls during one execution session
# Counter resets for each new execution request
# Default: 100
# NEAR_RPC_PROXY_MAX_CALLS=100

# Allow NEAR transaction methods (send_tx, broadcast_tx_*)
# If false, only view methods are allowed (safer)
# WASM code must provide its own signing keys for transactions
# Default: true
# NEAR_RPC_PROXY_ALLOW_TRANSACTIONS=true

# ============================================================================
# KEYSTORE WORKER CONFIGURATION (Optional - for secret decryption)
# ============================================================================

# Keystore worker URL
# If set, worker will request secret decryption from keystore
# If not set, encrypted secrets will be ignored
# Example: http://localhost:8081
# KEYSTORE_BASE_URL=http://localhost:8081

# Keystore authentication token
# Must match a token configured in keystore worker
# Only required if KEYSTORE_BASE_URL is set
# KEYSTORE_AUTH_TOKEN=your_keystore_token_here

# TEE mode for attestation generation
# Options: tdx, sgx, sev, simulated, none
# - tdx: Intel TDX attestation (Phala Cloud production) ⭐ RECOMMENDED FOR PHALA
# - sgx: Intel SGX attestation (legacy production)
# - sev: AMD SEV-SNP attestation (legacy production)
# - simulated: Simulated TEE for testing (uses worker binary hash as measurement)
# - none: No TEE, no attestation (dev mode)
# Default: none
#
# FOR PHALA CLOUD DEPLOYMENT:
# - Set TEE_MODE=tdx (Phala uses Intel TDX)
# - Worker will call /var/run/dstack.sock for TDX quote generation
# - Coordinator must be accessible via public URL (not localhost)
#
# TEE_MODE=none

# ============================================================================
# WORKER REGISTRATION CONFIGURATION (RECOMMENDED - for TEE key generation)
# ============================================================================

# Register contract account ID (RECOMMENDED)
# If set, worker will:
# 1. Generate keypair in TEE (~/.near-credentials/worker-keypair.json)
# 2. Register public key with TDX attestation via this contract
# 3. Contract adds key as full access key to OPERATOR_ACCOUNT_ID
# 4. Worker uses generated key to sign all transactions (no OPERATOR_PRIVATE_KEY needed)
# 5. On restart, worker loads existing keypair and verifies it's registered
#
# If not set, worker uses legacy mode (requires OPERATOR_PRIVATE_KEY in .env)
#
# Example: register.outlayer.near
REGISTER_CONTRACT_ID=register.outlayer.testnet

# Init account (optional - for paying gas on worker registration)
# If set, this account will be used to pay gas fees for registration transactions
# If not set, OPERATOR_ACCOUNT_ID will be used for both registration and execution results
#
# This allows separating concerns:
# - Init account: shared across workers, only pays for registration
# - Operator account: unique per worker, submits execution results
#
# Example: init-worker.outlayer.testnet
# INIT_ACCOUNT_ID=init-worker.outlayer.testnet
# INIT_ACCOUNT_PRIVATE_KEY=ed25519:YOUR_INIT_ACCOUNT_KEY_HERE

# DEPRECATED: REGISTER_COLLATERAL_JSON is no longer used
# Worker automatically fetches collateral from Phala Cloud API when needed
# See section above for more details

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

# Logging level (set via RUST_LOG environment variable)
# Examples:
#   info  - Standard logging (recommended for production)
#   debug - Detailed logging (recommended for development)
#   trace - Very verbose logging (for debugging issues)
#
# Usage:
#   RUST_LOG=offchainvm_worker=info cargo run
#   RUST_LOG=offchainvm_worker=debug cargo run

# ============================================================================
# DEBUG CONFIGURATION (Admin Only)
# ============================================================================

# Save raw compilation/execution logs to system_hidden_logs table
# ⚠️ SECURITY WARNING: These logs may contain system file contents from malicious code
# ⚠️ The system_hidden_logs table should NEVER be exposed via public API
# ⚠️ Access ONLY via /admin/* endpoints on localhost/SSH
#
# When enabled, stores raw stderr/stdout for admin debugging
# When disabled, only safe user-facing error descriptions are stored
#
# Options: true, false
# Default: true (enabled for debugging)
# Production recommendation: false
#
# SAVE_SYSTEM_HIDDEN_LOGS_TO_DEBUG=true

# Print WASM stderr output to worker logs (for debugging WASM execution)
# When enabled, any eprintln!() or log messages from WASM code will be
# printed to worker console with INFO level
#
# This is useful for debugging WASM execution locally with RUST_LOG=info
# Set to false in production to reduce log noise
#
# Options: true, false
# Default: false
#
# PRINT_WASM_STDERR=true

# ============================================================================
# EXAMPLE CONFIGURATIONS
# ============================================================================

# --- Local Development Example ---
# API_BASE_URL=http://localhost:8080
# API_AUTH_TOKEN=dev-token-123
# NEAR_RPC_URL=https://rpc.testnet.near.org
# OFFCHAINVM_CONTRACT_ID=dev-outlayer.testnet
# OPERATOR_ACCOUNT_ID=dev-worker.testnet
# OPERATOR_PRIVATE_KEY=ed25519:...
# WORKER_ID=dev-worker-1
# ENABLE_EVENT_MONITOR=false

# --- Production Example (Testnet) ---
# API_BASE_URL=https://coordinator.example.com
# API_AUTH_TOKEN=prod_token_random_secure_string
# NEAR_RPC_URL=https://rpc.testnet.near.org
# OFFCHAINVM_CONTRACT_ID=outlayer.testnet
# OPERATOR_ACCOUNT_ID=worker1.example.near
# OPERATOR_PRIVATE_KEY=ed25519:...
# WORKER_ID=prod-worker-1
# ENABLE_EVENT_MONITOR=true
# COMPILE_TIMEOUT_SECONDS=600
# COMPILE_MEMORY_LIMIT_MB=4096

# --- Production Example (Mainnet) ---
# API_BASE_URL=https://coordinator.example.com
# API_AUTH_TOKEN=prod_token_random_secure_string
# NEAR_RPC_URL=https://rpc.mainnet.near.org
# OFFCHAINVM_CONTRACT_ID=outlayer.near
# OPERATOR_ACCOUNT_ID=worker1.example.near
# OPERATOR_PRIVATE_KEY=ed25519:...
# WORKER_ID=prod-worker-mainnet-1
# ENABLE_EVENT_MONITOR=true

# --- Phala Cloud TEE Deployment Example ---
# ⭐ RECOMMENDED FOR PRODUCTION WITH TEE ATTESTATIONS
#
# IMPORTANT: Coordinator must be running on a PUBLIC domain (not localhost)
# Example: api.outlayer.fastnear.com
#
# API_BASE_URL=https://api.outlayer.fastnear.com
# API_AUTH_TOKEN=your_worker_auth_token_from_coordinator_db
# NEAR_RPC_URL=https://rpc.mainnet.near.org
# OFFCHAINVM_CONTRACT_ID=outlayer.near
# OPERATOR_ACCOUNT_ID=worker1.outlayer.near
# OPERATOR_PRIVATE_KEY=ed25519:...
# WORKER_ID=phala-worker-1
# ENABLE_EVENT_MONITOR=true
#
# TEE Configuration (CRITICAL):
# TEE_MODE=tdx  # MUST be 'tdx' for Phala Cloud
#
# Keystore (if using encrypted secrets):
# KEYSTORE_BASE_URL=https://keystore.outlayer.fastnear.com
# KEYSTORE_AUTH_TOKEN=your_keystore_token
#
# Build Settings (adjust based on your app):
# COMPILE_TIMEOUT_SECONDS=600
# COMPILE_MEMORY_LIMIT_MB=4096
# COMPILE_CPU_LIMIT=2.0
#
# Execution Limits:
# DEFAULT_MAX_INSTRUCTIONS=100000000000
# DEFAULT_MAX_MEMORY_MB=256
# DEFAULT_MAX_EXECUTION_SECONDS=60
#
# ============================================================================
# PHALA CLOUD DEPLOYMENT CHECKLIST
# ============================================================================
#
# Before deploying to Phala Cloud:
#
# 1. Deploy coordinator to public server with domain (e.g., api.outlayer.fastnear.com)
# 2. Run database migrations on coordinator
# 3. Generate worker auth token and add to coordinator database
# 4. Set API_BASE_URL to your public coordinator URL (NOT localhost!)
# 5. Set TEE_MODE=tdx
# 6. Deploy worker Docker image to Phala Cloud
# 7. After first deployment:
#    - Get RTMR3 measurement from first TDX quote
#    - Update EXPECTED_WORKER_MEASUREMENT in coordinator config
#    - Restart coordinator
# 8. Test attestation generation:
#    - curl https://api.outlayer.fastnear.com/attestations/{task_id} -H "X-API-Key: <key>"
#
# Coordinator URL Requirements:
# - Must be HTTPS with valid SSL certificate
# - Must be publicly accessible from Phala Cloud network
# - Worker auth token must be configured in coordinator database
#
# Network Configuration:
# - Phala worker runs in Docker container with internet access
# - Uses public DNS to reach coordinator
# - No localhost/127.0.0.1 connections possible
# - Coordinator authenticates worker via API_AUTH_TOKEN (Bearer token)
