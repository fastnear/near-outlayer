name: Release Docker Images

on:
  push:
    tags:
      - 'v*'

permissions:
  attestations: write
  id-token: write
  contents: write
  packages: write

jobs:
  build-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.worker-phala
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-worker:${{ github.ref_name }}
            ${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-worker:latest
          platforms: linux/amd64

      - uses: actions/attest-build-provenance@v1
        with:
          subject-name: "docker.io/${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-worker"
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true
        env:
          DOCKER_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

    outputs:
      digest: ${{ steps.build.outputs.digest }}

  build-keystore:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.keystore-phala
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-keystore:${{ github.ref_name }}
            ${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-keystore:latest
          platforms: linux/amd64

      - uses: actions/attest-build-provenance@v1
        with:
          subject-name: "docker.io/${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-keystore"
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true
        env:
          DOCKER_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

    outputs:
      digest: ${{ steps.build.outputs.digest }}

  release:
    needs: [build-worker, build-keystore]
    runs-on: ubuntu-latest
    steps:
      - uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Docker Images with Sigstore Attestation

            | Image | Digest | Verify |
            |-------|--------|--------|
            | worker | `${{ needs.build-worker.outputs.digest }}` | [Sigstore](https://search.sigstore.dev/?hash=${{ needs.build-worker.outputs.digest }}) |
            | keystore | `${{ needs.build-keystore.outputs.digest }}` | [Sigstore](https://search.sigstore.dev/?hash=${{ needs.build-keystore.outputs.digest }}) |

            ### Verification
            ```bash
            gh attestation verify oci://docker.io/${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-worker@${{ needs.build-worker.outputs.digest }} -R fastnear/near-outlayer
            ```

            ### Usage in docker-compose
            ```yaml
            image: docker.io/${{ vars.DOCKERHUB_USERNAME }}/near-outlayer-worker@${{ needs.build-worker.outputs.digest }}
            ```
