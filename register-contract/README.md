# Register Contract - TEE Worker Key Registration

**Contract**: `register.outlayer.near`
**Purpose**: Verify TDX attestations and register worker public keys with cryptographic proof

---

## Quick Start

```bash
# Build
./build.sh

# Deploy
near deploy register.outlayer.near \
  use-file res/local/register_contract.wasm \
  with-init-call new \
  json-args '{"owner_id":"outlayer.near","operator_account_id":"operator.outlayer.near"}' \
  prepaid-gas '100.0 Tgas' network-config mainnet sign-with-keychain send

# Add approved RTMR3
near call register.outlayer.near add_approved_rtmr3 \
  '{"rtmr3":"<96-hex-chars>"}' --accountId outlayer.near

# Update collateral
near call register.outlayer.near update_collateral \
  "$(cat collateral.json | jq -c)" --accountId outlayer.near --gas 300000000000000
```

---

## Overview

### Problem Solved

**Before**: Operator private key generated by admin → Admin can fake results
**After**: Operator key generated in TEE → Cryptographically proven, admin cannot fake

### How It Works

```
1. Worker starts in Phala TEE
2. Worker generates keypair (private key NEVER leaves TEE)
3. Worker generates TDX quote with public key embedded
4. Worker calls register.outlayer.near::register_worker_key()
5. Contract verifies TDX quote (Intel signature)
6. Contract checks RTMR3 in approved list
7. Contract adds public key to operator.outlayer.near
8. Worker uses this key to sign resolve_execution transactions
```

**Result**: Users can trust that results are signed by keys generated in approved TEE

---

## API

### Admin Methods

#### `add_approved_rtmr3(rtmr3: String)`

Add RTMR3 to approved list. Only approved RTMR3 can register keys.

```bash
near call register.outlayer.near add_approved_rtmr3 \
  '{"rtmr3":"3f2a1b4c..."}' --accountId outlayer.near
```

#### `remove_approved_rtmr3(rtmr3: String)`

Remove RTMR3 from approved list.

```bash
near call register.outlayer.near remove_approved_rtmr3 \
  '{"rtmr3":"3f2a1b4c..."}' --accountId outlayer.near
```

#### `update_collateral(collateral: String)`

Update Intel collateral data for TDX verification.

**Frequency**: Weekly or when Intel releases TCB updates

```bash
near call register.outlayer.near update_collateral \
  "$(cat collateral.json | jq -c)" \
  --accountId outlayer.near \
  --gas 300000000000000
```

#### `transfer_ownership(new_owner: AccountId)`

Transfer contract ownership.

```bash
near call register.outlayer.near transfer_ownership \
  '{"new_owner":"new-admin.near"}' --accountId outlayer.near
```

### Worker Methods

#### `register_worker_key(public_key: PublicKey, tdx_quote_hex: String, quote_collateral: Option<String>)`

Register worker public key with TEE proof.

Called by worker on startup via gas account (e.g., worker1.outlayer.near).

```bash
near call register.outlayer.near register_worker_key \
  '{"public_key":"ed25519:ABC...","tdx_quote_hex":"48656c6c6f...","quote_collateral":null}' \
  --accountId worker1.outlayer.near \
  --gas 300000000000000 \
  --deposit 0.1
```

**What happens**:
1. Verifies TDX quote signature (Intel)
2. Extracts RTMR3 from quote
3. Checks RTMR3 in approved list
4. Extracts public key from quote report_data
5. Verifies public_key matches embedded key
6. Adds access key to operator.outlayer.near with FunctionCall permission

**Returns**: Promise (adds key to operator account)

### View Methods

#### `get_approved_rtmr3() -> Vec<String>`

Get list of approved RTMR3 measurements.

```bash
near view register.outlayer.near get_approved_rtmr3
```

#### `is_rtmr3_approved(rtmr3: String) -> bool`

Check if RTMR3 is approved.

```bash
near view register.outlayer.near is_rtmr3_approved \
  '{"rtmr3":"3f2a1b4c..."}'
```

#### `get_operator_account() -> AccountId`

Get operator account ID where keys are added.

```bash
near view register.outlayer.near get_operator_account
```

#### `get_collateral() -> Option<String>`

Get cached collateral data.

```bash
near view register.outlayer.near get_collateral
```

---

## Documentation

- **[DEPLOYMENT.md](./DEPLOYMENT.md)** - Complete deployment and maintenance guide
- **[COLLATERAL_TECHNICAL.md](./COLLATERAL_TECHNICAL.md)** - Technical details on collateral management

---

## Architecture

```
┌─────────────────────────────────────────────────────┐
│ Worker (Phala TEE)                                  │
│  1. Generate ed25519 keypair                        │
│     Private: NEVER leaves TEE                       │
│     Public: ed25519:ABC...                          │
│                                                      │
│  2. Create TDX quote commitment                     │
│     report_data[0..32] = public_key_bytes           │
│                                                      │
│  3. Generate TDX quote via /var/run/dstack.sock     │
│     Quote contains:                                 │
│       - RTMR3 (TEE measurement)                     │
│       - Public key (in report_data)                 │
│       - Intel signature                             │
└────────────────┬────────────────────────────────────┘
                 │
                 │ POST with gas account key
                 │
                 ↓
┌─────────────────────────────────────────────────────┐
│ register.outlayer.near                              │
│                                                      │
│  1. Parse TDX quote                                 │
│  2. Verify Intel signature (using collateral)       │
│  3. Extract RTMR3                                   │
│  4. Check RTMR3 in approved_rtmr3 list ✅           │
│  5. Extract public_key from report_data             │
│  6. Verify public_key matches provided key ✅       │
│                                                      │
│  7. Add access key to operator.outlayer.near        │
│     - Public key: ed25519:ABC...                    │
│     - Allowance: 10 NEAR                            │
│     - Receiver: outlayer.near                       │
│     - Methods: resolve_execution                    │
└────────────────┬────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────┐
│ operator.outlayer.near                              │
│                                                      │
│  Access keys:                                       │
│    ed25519:ABC... → FunctionCall(outlayer.near)     │
│    ed25519:DEF... → FunctionCall(outlayer.near)     │
│    ed25519:GHI... → FunctionCall(outlayer.near)     │
│                                                      │
│  Each key cryptographically proven to be            │
│  generated in approved TEE                          │
└─────────────────────────────────────────────────────┘
```

---

## Security Model

### Trust Assumptions

1. **Intel TDX**: Trust Intel's cryptographic signature on quotes
2. **Owner account**: Trust `outlayer.near` to manage approved RTMR3 list
3. **Gas accounts**: Trust that gas account keys are secured

### What This Prevents

✅ **Admin faking results**: Admin cannot generate valid signatures (no TEE key)
✅ **Rogue workers**: Only approved RTMR3 can register keys
✅ **Key theft**: Private keys never leave TEE
✅ **Replay attacks**: TDX quotes include timestamps (checked against collateral)

### What This Doesn't Prevent

❌ **Admin disabling workers**: Admin can remove RTMR3 from approved list
❌ **Gas account compromise**: If gas account key leaked, attacker can register fake keys (but still need valid TDX quote)
❌ **Intel root compromise**: If Intel's root key compromised, all bets off

---

## Gas and Storage

### Contract Deployment
- **Gas**: ~100 TGas
- **Storage**: 450-500 KB WASM (due to dcap-qvl library)

### Worker Registration
- **Gas**: 200-300 TGas (TDX verification is expensive)
- **Deposit**: 0.1 NEAR (covers add_access_key storage)
- **Paid by**: Worker's gas account (e.g., worker1.outlayer.near)

### Collateral Update
- **Gas**: 200-300 TGas (large JSON data)
- **Paid by**: Admin (outlayer.near)

---

## Testing

```bash
# Unit tests
cd register-contract
cargo test

# Integration test (requires deployed contract)
./test_registration.sh
```

---

## Troubleshooting

### "RTMR3 not approved"
→ Add RTMR3: `near call register.outlayer.near add_approved_rtmr3 '{"rtmr3":"..."}' --accountId outlayer.near`

### "TDX quote verification failed"
→ Update collateral: `near call register.outlayer.near update_collateral ...`

### "Out of gas"
→ Top up gas account: `near send outlayer.near worker1.outlayer.near 5`

### "Public key mismatch"
→ Worker bug - public key in TDX quote doesn't match provided key

---

## Maintenance

### Weekly
- Update collateral (Intel releases TCB updates)

### On Worker Update
- Get new RTMR3 from coordinator DB
- Add to approved list

### Monthly
- Check gas account balances
- Review access keys on operator account

---

## References

- **Intel TDX**: https://www.intel.com/content/www/us/en/developer/tools/trust-domain-extensions/overview.html
- **dcap-qvl**: https://github.com/Phala-Network/dcap-qvl
- **NEAR Access Keys**: https://docs.near.org/concepts/basics/accounts/access-keys
- **Phala Network**: https://phala.network

---

**Version**: 1.0.0
**Status**: ✅ Production Ready
**License**: MIT
