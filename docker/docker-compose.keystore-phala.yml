version: '3.8'

services:
  keystore:
    image: ${DOCKER_IMAGE_KEYSTORE}
    container_name: keystore

    environment:
      - SERVER_HOST=${SERVER_HOST}
      - SERVER_PORT=${SERVER_PORT}
      - NEAR_NETWORK=${NEAR_NETWORK}
      - NEAR_RPC_URL=${NEAR_RPC_URL}
      - OFFCHAINVM_CONTRACT_ID=${OFFCHAINVM_CONTRACT_ID}
      - NEAR_CONTRACT_ID=${NEAR_CONTRACT_ID}
      - ALLOWED_WORKER_TOKEN_HASHES=${ALLOWED_WORKER_TOKEN_HASHES}
      - ALLOWED_COORDINATOR_TOKEN_HASHES=${ALLOWED_COORDINATOR_TOKEN_HASHES}

      # TEE and DAO Registration
      - TEE_MODE=${TEE_MODE}
      - USE_TEE_REGISTRATION=${USE_TEE_REGISTRATION}
      - KEYSTORE_DAO_CONTRACT=${KEYSTORE_DAO_CONTRACT}
      - INIT_ACCOUNT_ID=${INIT_ACCOUNT_ID}
      - INIT_ACCOUNT_PRIVATE_KEY=${INIT_ACCOUNT_PRIVATE_KEY}
      # MPC CKD Configuration
      - MPC_CONTRACT_ID=${MPC_CONTRACT_ID:-v1.signer-prod.testnet}
      - MPC_DOMAIN_ID=${MPC_DOMAIN_ID:-2}
      - MPC_PUBLIC_KEY=${MPC_PUBLIC_KEY}
      # Optional: Master secret (only for non-TEE mode)
      # - KEYSTORE_MASTER_SECRET=${KEYSTORE_MASTER_SECRET:-}
      # Logging
      - LOG_MASTER_KEY_HASH=${LOG_MASTER_KEY_HASH:-false}
      - RUST_LOG=${RUST_LOG}
      # Phala dstack socket endpoint
      - DSTACK_SIMULATOR_ENDPOINT=${DSTACK_SIMULATOR_ENDPOINT}

    ports:
      - "${SERVER_PORT}:${SERVER_PORT}"

    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock

    restart: always
