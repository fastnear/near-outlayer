version: '3.8'

# Docker Compose configuration for NEAR OutLayer Worker with Native Compilation
# Phala Cloud Deployment - Intel TDX TEE with Built-in Rust Compiler
#
# This configuration runs a worker that can both compile and execute WASM:
# - Native Rust toolchain (rustc, cargo, wasm32-wasip1/wasip2)
# - WASI SDK for C dependencies (ring, openssl-sys, etc.)
# - Environment isolation (env -i) + resource limits (ulimit)
# - Intel TDX attestation via /var/run/dstack.sock
#
# Image size: ~700-800MB (vs ~50MB execution-only worker)
# Use case: TEE environments where Docker-in-Docker doesn't work
#
# Deploy via Phala Cloud CLI:
#   cd docker
#   phala deploy \
#     --name outlayer-testnet-worker-compiler \
#     --compose docker-compose.worker-compiler.phala.yml \
#     --env-file .env.testnet-worker-phala \
#     --vcpu 2 --memory 4G --disk-size 10G \
#     --kms-id phala-prod10

services:
  # Main worker service with compilation capabilities
  worker:
    image: ${DOCKER_IMAGE_WORKER}
    container_name: near-outlayer-worker-compiler
    restart: on-failure:5  # Testnet: will spend gas on startup retries

    environment:
      # === Coordinator API ===
      API_BASE_URL: ${API_BASE_URL}
      API_AUTH_TOKEN: ${API_AUTH_TOKEN}

      # === NEAR Configuration ===
      NEAR_RPC_URL: ${NEAR_RPC_URL}
      OFFCHAINVM_CONTRACT_ID: ${OFFCHAINVM_CONTRACT_ID}
      OPERATOR_ACCOUNT_ID: ${OPERATOR_ACCOUNT_ID}
      # OPERATOR_PRIVATE_KEY only needed when USE_TEE_REGISTRATION=false (legacy mode)
      # In TEE mode, key is generated during registration
      OPERATOR_PRIVATE_KEY: ${OPERATOR_PRIVATE_KEY:-}

      # === TEE Configuration (Phala Cloud) ===
      TEE_MODE: ${TEE_MODE:-tdx}
      USE_TEE_REGISTRATION: ${USE_TEE_REGISTRATION:-true}

      # === Worker Capabilities ===
      COMPILATION_ENABLED: ${COMPILATION_ENABLED:-true}
      EXECUTION_ENABLED: ${EXECUTION_ENABLED:-true}

      # === Compilation Mode (CRITICAL!) ===
      # "native" - use bubblewrap (recommended for TEE/Phala)
      # "docker" - use Docker-in-Docker (doesn't work in most TEE environments)
      COMPILATION_MODE: ${COMPILATION_MODE}

      # Compilation settings (for native mode)
      COMPILE_TIMEOUT_SECONDS: ${COMPILE_TIMEOUT_SECONDS:-300}
      COMPILE_MEMORY_LIMIT_MB: ${COMPILE_MEMORY_LIMIT_MB:-2048}
      COMPILE_CPU_LIMIT: ${COMPILE_CPU_LIMIT:-2.0}

      # === Worker Registration (register-contract is deployed at OPERATOR_ACCOUNT_ID) ===
      # Init Account (pays gas for worker registration when USE_TEE_REGISTRATION=true)
      INIT_ACCOUNT_ID: ${INIT_ACCOUNT_ID:-}
      INIT_ACCOUNT_PRIVATE_KEY: ${INIT_ACCOUNT_PRIVATE_KEY:-}

      # === Keystore (optional - for encrypted secrets) ===
      KEYSTORE_BASE_URL: ${KEYSTORE_BASE_URL:-}
      KEYSTORE_AUTH_TOKEN: ${KEYSTORE_AUTH_TOKEN:-}

      # === Logging ===
      RUST_LOG: ${RUST_LOG:-info}
      SAVE_SYSTEM_HIDDEN_LOGS_TO_DEBUG: ${SAVE_SYSTEM_HIDDEN_LOGS_TO_DEBUG:-false}
      PRINT_WASM_STDERR: ${PRINT_WASM_STDERR:-false}

      # === Event Monitor (optional) ===
      ENABLE_EVENT_MONITOR: ${ENABLE_EVENT_MONITOR:-false}
      NEARDATA_API_URL: ${NEARDATA_API_URL:-}
      FASTNEAR_API_URL: ${FASTNEAR_API_URL:-}
      START_BLOCK_HEIGHT: ${START_BLOCK_HEIGHT:-0}

      # Polling
      POLL_TIMEOUT_SECONDS: 30

    # Worker needs access to dstack socket for TDX quotes
    # Phala provides this automatically at /var/run/dstack.sock
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock:ro

    # No special capabilities required - env isolation works unprivileged
    # Intel TDX provides hardware-level isolation

    # Health check
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "-v", "grep", "|", "grep", "worker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Network configuration
# Phala Cloud provides Docker bridge network automatically
networks:
  default:
    name: near-outlayer-compiler-network
